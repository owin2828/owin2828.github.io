<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    [Spring] 첫걸음 - 8 - 낮코밤코
    
  </title>

  <meta name="description" content="1.스프링의 DB 연동 이점 스프링은 기존의 jdbc의 단점(구조적으로 반복되는 비핵심기능들)을 보완 jdbc는 여기를 참조 자바8의 람다를 사용하면 더 효율적인 개선 가능 트랙잭션의 관리가 쉬움 트랜잭션은 데이터베이스 뿐 아니라, 한번에 처리해야할 일의 묶음, 단위를 보장하는 의...">

  <link href='http://cdn.jsdelivr.net/gh/joungkyun/font-d2coding/d2coding.css' rel='stylesheet' type='text/css'>
  <!-- <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'> -->

  <link rel="stylesheet" href="/assets/vendor/bootstrap/css/bootstrap.css">

  <link rel="stylesheet" href="/assets/vendor/fontawesome-free/css/all.min.css">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://owin2828.github.io/devlog/2019/12/30/spring-8.html">
  <link rel="alternate" type="application/rss+xml" title="낮코밤코" href="/feed.xml">

  <!-- 웹 폰트 설정 -->
  <!-- <link rel="stylesheet" href="http://cdn.jsdelivr.net/gh/joungkyun/font-d2coding/d2coding.css"> -->
  <link rel="stylesheet" href="/assets/syntax.css">
</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">Fake it, till U make it</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/about">About</a>
        <li class="nav-item">
          <a class="nav-link" href="/posts">All Posts</a>
        </li>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href=# id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Devlog
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <a class="dropdown-item" href="/devlog/java">Java</a>
            <a class="dropdown-item" href="/devlog/node">Node.js</a>
            <a class="dropdown-item" href="/devlog/spring">Spring</a>
          </div>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/contact">Contact</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->

<header class="masthead" style="background-image: url('/img/spring_logo.jpg')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>[Spring] 첫걸음 - 8</h1>
            
            <h2 class="subheading">DB 연동</h2>
            
            <span class="meta">Posted by
              <a href="#">owin2828</a>
              on 16:05:00 December 30, 2019 &middot; <span class="reading-time" title="Estimated read time">
  
   18 mins  read </span>

            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">

        <h2 id="1스프링의-db-연동-이점">1.스프링의 DB 연동 이점</h2>
<hr />
<ul>
  <li>스프링은 기존의 jdbc의 단점(구조적으로 <code class="highlighter-rouge">반복</code>되는 비핵심기능들)을 보완
    <blockquote>
      <p>jdbc는 <a href="../0.부록/3.-JDBC란">여기</a>를 참조</p>
    </blockquote>
  </li>
  <li>자바8의 <code class="highlighter-rouge">람다</code>를 사용하면 더 효율적인 개선 가능</li>
  <li><code class="highlighter-rouge">트랙잭션</code>의 관리가 쉬움
    <blockquote>
      <p><code class="highlighter-rouge">트랜잭션</code>은 데이터베이스 뿐 아니라, <code class="highlighter-rouge">한번에</code> 처리해야할 일의 묶음, 단위를 <code class="highlighter-rouge">보장</code>하는 의미로 사용<br />
<br /></p>
    </blockquote>
  </li>
</ul>

<h4 id="1-1-maven-프로젝트-생성">1-1. Maven 프로젝트 생성</h4>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-jdbc<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>5.0.2.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>tomcat-jdbc<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>8.5.27<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>8.0.16<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>
<ul>
  <li>spring-jdbc: JdbcTemplate 등 <code class="highlighter-rouge">JDBC</code> 연동에 필요한 기능을 제공</li>
  <li>tomcat-jdbc: <code class="highlighter-rouge">DB 커넥션풀</code> 기능을 제공</li>
  <li>mysql-connector-java: <code class="highlighter-rouge">MySQL 연결</code>에 필요한 JDBC 드라이버 제공
    <blockquote>
      <p>DB 커넥션풀은 <a href="../0.부록/4.-커넥션-풀">여기</a>를 참조<br />
<br /></p>
    </blockquote>
  </li>
</ul>

<h4 id="1-2-db-테이블-생성">1-2. DB 테이블 생성</h4>
<ul>
  <li>MySQL 5.7.27 버전 사용</li>
  <li>ID(Primary Key), EMAIL(Unique Key), PASSWORD, NAME, REGDATE을 필드로 갖는 테이블 MEMBER 생성<br />
<br /></li>
</ul>

<h4 id="1-3-datasource-설정">1-3. DataSource 설정</h4>
<p>JDBC API는 DriverManager 외에 <code class="highlighter-rouge">DataSource</code>를 이용해 DB 연결을 구하는 방법을 다음과 같이 정의</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nc">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span><span class="o">{</span>
        <span class="c1">// datasource는 생성자나 설정 매서드를 이용해 주입</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="o">...</span>
</code></pre></div></div>

<ul>
  <li>스프링이 제공하는 DB연동 기능은 <code class="highlighter-rouge">DataSource</code>를 사용해 DB Connection을 구함</li>
  <li>DB 연동에 사용할 DataSource를 스프링 <code class="highlighter-rouge">Bean</code>으로 등록하고,<br />
DB 연동 기능을 구현한 Bean객체는 DataSource를 <code class="highlighter-rouge">주입</code>받아 사용
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// AppCtx.java</span>
  <span class="nd">@Configuration</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppCtx</span> <span class="o">{</span>

          <span class="cm">/* 
          * datasource() 매서드를 통해 DataSource를 스프링 Bean으로 등록
          * 아래의 destroyMethod = "close"를 지정함으로써, 
          * 커넥션 풀에 보관된 Connection들을 닫는 매서드 호출까지를 Bean의 생명주기로 지정
          */</span>
      <span class="nd">@Bean</span><span class="o">(</span><span class="n">destroyMethod</span> <span class="o">=</span> <span class="s">"close"</span><span class="o">)</span>
      <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
          <span class="c1">// DataSource 객체 생성</span>
          <span class="nc">DataSource</span> <span class="n">ds</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataSource</span><span class="o">();</span>
          <span class="c1">// JDBC 드라이버 클래스를 지정, 여기서는 MYSQL 드라이버 클래스 사용</span>
          <span class="n">ds</span><span class="o">.</span><span class="na">setDriverClassName</span><span class="o">(</span><span class="s">"com.mysql.jdbc.Driver"</span><span class="o">);</span>
          <span class="c1">// URL 지정</span>
          <span class="n">ds</span><span class="o">.</span><span class="na">setUrl</span><span class="o">(</span><span class="s">"jdbc:mysql://localhost/spring5fs?characterEncoding=utf8"</span><span class="o">);</span>
          <span class="c1">// 계정 &amp; 암호 지정</span>
          <span class="n">ds</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"spring5"</span><span class="o">);</span>
          <span class="n">ds</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">"spring5"</span><span class="o">);</span>
          <span class="o">...</span>
          <span class="k">return</span> <span class="n">ds</span><span class="o">;</span>
      <span class="o">}</span>
          <span class="o">...</span>
      <span class="nd">@Bean</span>
      <span class="kd">public</span> <span class="nc">MemberDao</span> <span class="nf">memberDao</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">return</span> <span class="k">new</span> <span class="nf">MemberDao</span><span class="o">(</span><span class="n">dataSource</span><span class="o">());</span>
      <span class="o">}</span>
          <span class="o">...</span>
  <span class="o">}</span>
</code></pre></div>    </div>
    <p><br /></p>
  </li>
</ul>

<h2 id="2-jdbctemplate을-이용한-쿼리-실행">2. JdbcTemplate을 이용한 쿼리 실행</h2>
<hr />
<p>스프링에서는 DataSource, Connection, Statement 및 ResultSet을 직접 사용하지 않고,<br />
<code class="highlighter-rouge">JdbcTemplate</code>을 이용해 <code class="highlighter-rouge">편리</code>하게 쿼리 실행 가능</p>
<blockquote>
  <p>DB의 데이터에 접근하는 자세한 방법은 <a href="../0.부록/5.-JDBC,-JPA-&amp;-Hibernate,-Mybatis의-차이">여기</a>를 참조</p>
</blockquote>

<h4 id="2-1-jdbctemplate-생성">2-1. JdbcTemplate 생성</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// MemberDao.java</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberDao</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>

            <span class="c1">// 필요한 dataSorce 객체를 주입받음</span>
        <span class="kd">public</span> <span class="nf">MemberDao</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">jdbcTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JdbcTemplate</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="o">...</span>
    <span class="o">}</span>
</code></pre></div></div>
<p><br /></p>

<h3 id="2-2-jdbctemplate을-이용한-조회-쿼리-실행">2-2. JdbcTemplate을 이용한 조회 쿼리 실행</h3>
<ul>
  <li>JdbcTemplate 클래스는 <code class="highlighter-rouge">SELECT</code> 쿼리 실행을 위한 <code class="highlighter-rouge">query()</code> 매서드를 다음과 같이 제공
    <ul>
      <li>List<T> quey(String sql, RowMapper<T> rowMapper)</T></T></li>
      <li>List<T> quey(String sql, Object[] args, RowMapper<T> rowMapper)</T></T></li>
      <li>List<T> quey(String sql, RowMapper<T> rowMapper, Object... args)</T></T></li>
    </ul>
  </li>
  <li>sql의 파라미터가 아래와 같이 <code class="highlighter-rouge">인덱스 기반</code> 파라미터를 가진 쿼리라면,<br />
<code class="highlighter-rouge">args</code> 파라미터를 이용하여 각 인덱스의 파라미터의 값을 지정
    <blockquote>
      <p>select * from member where email=?</p>
    </blockquote>
  </li>
  <li>RowMapper의  mapRow() 매서드는 실행 결과로 구한 ResultSet의 <code class="highlighter-rouge">한 행</code>을 읽어와 <code class="highlighter-rouge">자바 객체</code>로 변환해주는 매퍼 기능 제공
    <blockquote>
      <p>ResultSet이란 SELECT문을 사용하여 얻어온 <code class="highlighter-rouge">레코드 값</code>들을 테이블의 형태로 갖게 되는 <code class="highlighter-rouge">객체</code></p>
    </blockquote>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// MemberDao.java</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberDao</span> <span class="o">{</span>
          <span class="o">...</span>
      <span class="c1">// 조회 쿼리 기능을 구현</span>
      <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">selectByEmail</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span>
                  <span class="s">"select * from MEMBER where EMAIL = ?"</span><span class="o">,</span>
                  <span class="k">new</span> <span class="nc">RowMapper</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;()</span> <span class="o">{</span>
                      <span class="nd">@Override</span>
                      <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">mapRow</span><span class="o">(</span><span class="nc">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">rowNum</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
                          <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">(</span>
                                  <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"EMAIL"</span><span class="o">),</span>
                                  <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"PASSWORD"</span><span class="o">),</span>
                                  <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"NAME"</span><span class="o">),</span>
                                  <span class="n">rs</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="s">"REGDATE"</span><span class="o">).</span><span class="na">toLocalDateTime</span><span class="o">());</span>
                          <span class="n">member</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">"ID"</span><span class="o">));</span>
                          <span class="k">return</span> <span class="n">member</span><span class="o">;</span>
                      <span class="o">}</span>
                  <span class="o">},</span> <span class="n">email</span><span class="o">);</span>

                  <span class="cm">/* 
                  * query() 매서드는 쿼리를 실행한 결과가 존재하지 않으면 0인 list를 반환하므로
                  * list가 비어있는지 여부로 결과가 존재하지 않는지 확인할 수 있음
                  */</span>
          <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">results</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>selectByEamil 매서드의 JdbcTemplate query() 매서드는 다음과 같이 <code class="highlighter-rouge">인덱스 파라미터(물음표)</code>를 포함</li>
  <li>인덱스 파라미터에 들어갈 값은 query() 매서드 맨 마지막 부분의 email 에서 전달
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span>
      <span class="s">"select * from MEMBER where EMAIL = ?"</span><span class="o">,</span>
      <span class="k">new</span> <span class="nc">RowMapper</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;()</span> <span class="o">{...</span><span class="err">코드생략</span><span class="o">},</span>
          <span class="n">email</span><span class="o">);</span> <span class="c1">// 물음표에 해당하는 값 전달</span>
</code></pre></div>    </div>
    <p><br /></p>
  </li>
</ul>

<h4 id="2-3-결과가-1행인-경우-사용할-수-있는-queryforobject-매서드">2-3. 결과가 1행인 경우 사용할 수 있는 queryForObject() 매서드</h4>
<ul>
  <li>count(*)과 같이 결과가 <code class="highlighter-rouge">한 행</code>으로 실행되는 경우 사용
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// MemberDao.java</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberDao</span> <span class="o">{</span>
      <span class="o">...</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">count</span><span class="o">()</span> <span class="o">{</span>
          <span class="nc">Integer</span> <span class="n">count</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span>
                  <span class="s">"select count(*) from MEMBER"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
          <span class="k">return</span> <span class="n">count</span><span class="o">;</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>queryForObject() 매서드의 두 번째 파라미터는 칼럼을 읽어올 때 사용할 타입을 지정</li>
  <li>
    <p>실행 결과 칼럼이 두 개 이상이면 RowMapper를 파라미터로 전달해 결과 생성</p>

    <blockquote>
      <p>queryForObject() 매서드를 사용하려면 쿼리 실행 결과는 <code class="highlighter-rouge">반드시 한 행</code>이어야 함<br />
만약 행이 없거나, 두 개 이상이면 <code class="highlighter-rouge">익셉션</code>이 발생<br />
<br /></p>
    </blockquote>
  </li>
</ul>

<h4 id="2-4-jdbctemplate을-이용한-변경-쿼리-실행">2-4. JdbcTemplate을 이용한 변경 쿼리 실행</h4>
<ul>
  <li>JdbcTemplate 클래스는 <code class="highlighter-rouge">INSERT</code>, <code class="highlighter-rouge">UPDATE</code>, <code class="highlighter-rouge">DELETE</code> 쿼리 실행을 위한 <code class="highlighter-rouge">update()</code> 매서드를 다음과 같이 제공
    <ul>
      <li>int update(String sql)</li>
      <li>int update(String sql, Object… args)</li>
    </ul>
  </li>
  <li>
    <p>update() 매서드는 쿼리 실행 결과로 <code class="highlighter-rouge">변경된 행의 개수</code>를 반환</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// MemberDao.java</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberDao</span> <span class="o">{</span>
      <span class="o">...</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span>
                  <span class="s">"update MEMBER set NAME = ?, PASSWORD = ? where EMAIL = ?"</span><span class="o">,</span>
                  <span class="n">member</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">member</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="n">member</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
      <span class="o">}</span>
</code></pre></div>    </div>
    <p><br /></p>
  </li>
</ul>

<h4 id="2-5-preparedstatementcreator를-이용한-쿼리-실행">2-5. PreparedStatementCreator를 이용한 쿼리 실행</h4>
<blockquote>
  <p>앞선 예제 코드의 경우, 첫 번째, 두 번째 세 번째 파라미터의 값으로 각각 <code class="highlighter-rouge">접근자</code>를 이용해 인덱스 파라미터의 값을 전달<br />
하지만 <code class="highlighter-rouge">직접</code> 인덱스 파라미터의 값을 설정해야 할 경우, <code class="highlighter-rouge">설정자</code>를 이용해 설정 가능</p>
  <ul>
    <li>PreparedStatementCreator를 인자로 받는 매서드를 이용해 아래와 같이 사용
      <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="k">new</span> <span class="nc">PreparedSatementCreator</span><span class="o">(){</span>
          <span class="nd">@Override</span>
          <span class="kd">public</span> <span class="nc">PreparedStatement</span> <span class="nf">createPreparedStatement</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">)</span>
          <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">{</span>
                  <span class="c1">// 파라미터로 전달받은 Connection을 이용해 PreparedStatement 생성</span>
                  <span class="nc">PreparedStatement</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span>
                      <span class="s">"insert into MEMBER (EMAIL, PASSWORD, NAME, REGDATE) values (?,?,?,?)"</span><span class="o">);</span>
                  <span class="c1">// 인덱스 파라미터 값 설정</span>
                  <span class="n">pstm</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
                  <span class="n">pstm</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span>
                  <span class="n">pstm</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                  <span class="n">pstm</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Timestamp</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getRegisterDateTime</span><span class="o">()));</span>
                  <span class="c1">// 생성한 PreparedStatement 객체 리턴</span>
                  <span class="k">return</span> <span class="n">pstm</span><span class="o">;</span>
          <span class="o">}</span>
  <span class="o">});</span>
</code></pre></div>      </div>
      <p><br /></p>
    </li>
  </ul>
</blockquote>

<h4 id="2-6-insert-쿼리-실행-시-keyholder를-이용해-자동-생성-키-값-구하기">2-6. INSERT 쿼리 실행 시 KeyHolder를 이용해 자동 생성 키 값 구하기</h4>
<ul>
  <li>MySQL의 <code class="highlighter-rouge">AUTO_INCREMENT</code> 칼럼을 가진 테이블에 값을 삽입하면 해당 칼럼의 값이 <code class="highlighter-rouge">자동</code>으로 생성되므로,<br />
다음과 같이 <code class="highlighter-rouge">INSERT</code> 쿼리에 자동 증가 칼럼에 해당하는 값이 <code class="highlighter-rouge">지정되지 않음</code>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span>
          <span class="s">"insert into MEMBER (EMAIL, PASSWORD, NAME, REGDATE) values (?,?,?,?)"</span><span class="o">,</span>
          <span class="n">member</span><span class="o">.</span><span class="na">getEmail</span><span class="o">(),</span> <span class="n">member</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="n">member</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> 
          <span class="k">new</span> <span class="nf">Timestamp</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getRegisterDateTime</span><span class="o">()));</span>
</code></pre></div>    </div>
  </li>
  <li>이러한 키 값을 <code class="highlighter-rouge">KeyHolder</code>를 사용해 다음과 같이 구할 수 있다.
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// MemberDao.java</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberDao</span> <span class="o">{</span>
      <span class="o">...</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">insert</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">KeyHolder</span> <span class="n">keyHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GeneratedKeyHolder</span><span class="o">();</span>
          <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="k">new</span> <span class="nc">PreparedStatementCreator</span><span class="o">()</span> <span class="o">{</span>
              <span class="nd">@Override</span>
              <span class="kd">public</span> <span class="nc">PreparedStatement</span> <span class="nf">createPreparedStatement</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">con</span><span class="o">)</span>
                      <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
                  <span class="c1">// 파라미터로 전달받은 Connection을 이용해서 PreparedStatement 생성</span>
                  <span class="nc">PreparedStatement</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span>
                          <span class="s">"insert into MEMBER (EMAIL, PASSWORD, NAME, REGDATE) "</span> <span class="o">+</span>
                          <span class="s">"values (?, ?, ?, ?)"</span><span class="o">,</span>
                          <span class="k">new</span> <span class="nc">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">"ID"</span> <span class="o">});</span> 
                                                  <span class="c1">// 여기서 자동 증가하는 key값을 두 번째 파라미터로 전달 </span>
                  <span class="c1">// 인덱스 파라미터 값 설정</span>
                  <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
                  <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span>
                  <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                  <span class="n">pstmt</span><span class="o">.</span><span class="na">setTimestamp</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span>
                          <span class="nc">Timestamp</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getRegisterDateTime</span><span class="o">()));</span>
                  <span class="c1">// 생성한 PreparedStatement 객체 리턴</span>
                  <span class="k">return</span> <span class="n">pstmt</span><span class="o">;</span>
              <span class="o">}</span>
          <span class="o">},</span> <span class="n">keyHolder</span><span class="o">);</span>
          <span class="nc">Number</span> <span class="n">keyValue</span> <span class="o">=</span> <span class="n">keyHolder</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
          <span class="n">member</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">keyValue</span><span class="o">.</span><span class="na">longValue</span><span class="o">());</span>
      <span class="o">}</span>
          <span class="o">...</span>
</code></pre></div>    </div>
  </li>
  <li>keyHolder 구현 클래스인 <code class="highlighter-rouge">GeneratedKeyHolder</code> 객체를 생성</li>
  <li>preparedStatement의 두 번째 파라미터로 new String[] {“ID”}(자동 증가 칼럼)을 전달</li>
  <li>update() 매서드에 두 번째 파라미터로 <code class="highlighter-rouge">keyHolder</code>를 전달
    <blockquote>
      <p>KeyHolder keyHolder = new <code class="highlighter-rouge">GeneratedKeyHolder()</code>;<br />
jdbcTemplate.update(new PreparedStatementCreator(){…생략}, <code class="highlighter-rouge">keyHolder</code>);</p>
    </blockquote>
  </li>
</ul>

<hr />
<blockquote>
  <p>여기까지 진행 후, Main 실행시, The server time zone value ‘KST’ ~~~ 라는 <code class="highlighter-rouge">익셉션</code>이 발생<br />
 MySQL 5.1.X 이후 KST <code class="highlighter-rouge">타임존</code>을 인식하지 못하는 에러가 발생<br />
 /etc/mysql/mysql.condf.d 설정 변경(경로는 상이할 수 있음)<br />
<br /></p>
</blockquote>

<h2 id="3-트래잭션-처리">3. 트래잭션 처리</h2>
<hr />
<ul>
  <li>트랜잭션(Transaction)이란?: 두 개 이상의 쿼리를 <code class="highlighter-rouge">한 작업</code>으로 실행할 때 사용</li>
  <li><code class="highlighter-rouge">Commit</code>, <code class="highlighter-rouge">Rollback</code>을 통해 전부 반영하거나 기존 상태로 되돌림</li>
  <li>JDBC는 Connection의 <code class="highlighter-rouge">setAutoCommit(false)</code>을 이용해 다음과 같이 트랜잭션을 시작하고 반영하거나 취소함
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nc">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="k">try</span><span class="o">{</span>
      <span class="o">...</span>
      <span class="n">conn</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span> <span class="c1">// 트랜잭션 범위 시작</span>
      <span class="o">...</span> <span class="err">쿼리실행</span>
      <span class="n">conn</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span> <span class="c1">// 트랜잭션 범위 종료: 커밋</span>
  <span class="o">}</span>
  <span class="k">catch</span><span class="o">(</span><span class="nc">SQLException</span> <span class="n">ex</span><span class="o">){</span>
      <span class="k">if</span><span class="o">(</span><span class="n">conn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
          <span class="c1">// 트랜잭션 범위 종료: 롤백</span>
          <span class="k">try</span><span class="o">{</span> <span class="n">conn</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span> <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">){}</span>
  <span class="o">}</span>
  <span class="k">finally</span><span class="o">{</span>
      <span class="k">if</span><span class="o">(</span><span class="n">conn</span><span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
          <span class="k">try</span><span class="o">{</span> <span class="n">conn</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">){}</span>
  <span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p>위와 같은 방식은 코드로 <code class="highlighter-rouge">직접</code> 트랜잭션의 범위를 설정하기 때문에, 개발자가 커밋이나 롤백을 <code class="highlighter-rouge">누락</code>하기 쉬움<br />
이에 다음에 나오는 스프링이 제공하는 방식을 사용<br />
<br /></p>
</blockquote>

<h4 id="3-1-tracsactional을-이용한-트랜잭션-처리">3-1. @Tracsactional을 이용한 트랜잭션 처리</h4>
<ul>
  <li>트랜잭션 범위에서 실행하고 싶은 매서드에 다음과 같이 <code class="highlighter-rouge">@Transactional</code> 어노테이션을 붙임
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// ChangePasswordService.java</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChangePasswordService</span> <span class="o">{</span>

      <span class="kd">private</span> <span class="nc">MemberDao</span> <span class="n">memberDao</span><span class="o">;</span>
        
      <span class="cm">/* 어노테이션을 사용해 트랜잭션 범위 설정
      * 따라서 memberDao.selectByEmail()에서 실행하는 쿼리와
      * member.changePassword()에서 실행하는 쿼리는 한 트랜잭션에 묶임
      */</span>
      <span class="nd">@Transactional</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">changePassword</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">,</span> <span class="nc">String</span> <span class="n">oldPwd</span><span class="o">,</span> <span class="nc">String</span> <span class="n">newPwd</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberDao</span><span class="o">.</span><span class="na">selectByEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">member</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nf">MemberNotFoundException</span><span class="o">();</span>

          <span class="n">member</span><span class="o">.</span><span class="na">changePassword</span><span class="o">(</span><span class="n">oldPwd</span><span class="o">,</span> <span class="n">newPwd</span><span class="o">);</span>

          <span class="n">memberDao</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="o">...</span>
  <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>@Transactional 어노테이션의 올바른 작동을 위해 다음과 같은 설정이 필요
    <ul>
      <li><code class="highlighter-rouge">플랫폼 트랜잭션 매니저</code>(PlatformTransactionManager) Bean 설정</li>
      <li>@Transactional 어노테이션 <code class="highlighter-rouge">활성화</code> 설정
        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// AppCtx.java</span>
  <span class="nd">@Configuration</span>
  <span class="c1">// 다음 어노테이션을 통해 @Transactional 어노테이션 활성화</span>
  <span class="nd">@EnableTransactionManagement</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppCtx</span> <span class="o">{</span>

  <span class="o">....</span>
  <span class="nd">@Bean</span>
      <span class="c1">// 플랫폼 트랜잭션 매니저 Bean 설정</span>
  <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">transactionManager</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">DataSourceTransactionManager</span> <span class="n">tm</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataSourceTransactionManager</span><span class="o">();</span>
      <span class="n">tm</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">());</span>
      <span class="k">return</span> <span class="n">tm</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></div>        </div>
        <p><br /></p>
      </li>
    </ul>
  </li>
</ul>

<h4 id="3-2-transactional과-프록시">3-2. @Transactional과 프록시</h4>
<ul>
  <li>스프링은 @Transactional 어노테이션을 이용해 트랜잭션을 처리시, 내부적으로 <code class="highlighter-rouge">AOP</code>를 사용</li>
  <li>
    <p>트랜잭션 처리는 <code class="highlighter-rouge">프록시</code>를 통해 이루어짐</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// MainForCPS.java</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainForCPS</span> <span class="o">{</span>

      <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">AnnotationConfigApplicationContext</span> <span class="n">ctx</span> <span class="o">=</span> 
                  <span class="k">new</span> <span class="nf">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="nc">AppCtx</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
          <span class="cm">/*
          * 아래 코드를 실행시, ChangePasswordService 객체 대신
          * 트랜잭션 처리를 위해 생성한 프록시를 리턴함
          */</span>
          <span class="nc">ChangePasswordService</span> <span class="n">cps</span> <span class="o">=</span> 
                  <span class="n">ctx</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"changePwdSvc"</span><span class="o">,</span> <span class="nc">ChangePasswordService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
          <span class="o">...</span>
  <span class="o">}</span>
</code></pre></div>    </div>
    <blockquote>
      <p>위의 코드가 실행되기까지 과정은 다음과 같다.</p>
      <ul>
        <li>MainForCPS -&gt; <code class="highlighter-rouge">프록시</code> (changePasswordService) -&gt; <code class="highlighter-rouge">플랫폼 트랜잭션 매니저</code> -&gt; 실제 기능(ChansgePasswordService)<br />
프록시 객체는 <code class="highlighter-rouge">@Transactional</code> 어노테이션이 붙은 매서드를 호출하면 <code class="highlighter-rouge">플랫폼 트랜잭션 매니저</code>를 사용해 트랜잭션을 시작</li>
        <li>결과에 따라 <code class="highlighter-rouge">커밋</code>하거나 <code class="highlighter-rouge">롤백</code><br />
<br /></li>
      </ul>
    </blockquote>
  </li>
</ul>

<h4 id="3-3-트랜잭션-전파">3-3. 트랜잭션 전파</h4>
<ul>
  <li><code class="highlighter-rouge">트랜잭션 전파</code>: 트랜잭션이 이미 실행되고 있는데, 내부에서 또 다른 트랜잭션이 수행되는 경우</li>
  <li>스프링에서 @Transactional의 propagation 속성은 기본값이 <code class="highlighter-rouge">Propagation.REQUIRED</code>로서 <br />
이미 수행된 트랜잭션이 있다면, 트랜잭션을 <code class="highlighter-rouge">새로 생성하지 않음</code>(기존 트랜잭션 그대로 사용)</li>
</ul>

<blockquote>
  <p><code class="highlighter-rouge">@Transactional</code>의 주요 속성</p>
  <ul>
    <li>value / propagation / isolation / timeout</li>
  </ul>
</blockquote>

<blockquote>
  <p><code class="highlighter-rouge">Propagation</code>의 주요 속성</p>
  <ul>
    <li>REQUIRED / MANDATORY / REQUIRES_NEW / SUPPORTS / NOT_SUPPORTED / NEVER / NESTED</li>
  </ul>
</blockquote>

<blockquote>
  <p><code class="highlighter-rouge">Isolation</code>의 주요 속성</p>
  <ul>
    <li>DEFAULT / READ_UNCOMMITED / READ_COMMITED / REPEATABLE_READ / SERIALIZABLE</li>
  </ul>
</blockquote>



        <hr>

        <div class="clearfix">

          
          <a class="btn btn-primary float-left" href="/devlog/2019/12/30/spring-7.html" data-toggle="tooltip" data-placement="top" title="[Spring] 첫걸음 - 7">&larr; Previous<span class="d-none d-md-inline">
              Post</span></a>
          
          
          <a class="btn btn-primary float-right" href="/devlog/2019/12/30/spring-9.html" data-toggle="tooltip" data-placement="top" title="[Spring] 첫걸음 - 9">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          

        </div>

      </div>
    </div>
  </div>




  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:owin2828@gmail.com">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          
          
          <li class="list-inline-item">
            <a href="https://github.com/owin2828">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="copyright text-muted">Copyright &copy; owin2828 2019</p>
      </div>
    </div>
  </div>
</footer>


  <script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/clean-blog.min.js"></script>

<script src="/assets/scripts.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154694140-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154694140-1');
</script>



</body>

</html>
