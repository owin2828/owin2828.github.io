<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    [Spring] 첫걸음 - 16 - 낮코밤코
    
  </title>

  <meta name="description" content="1. Jackson 의존 설정 Jackson은 자바 객체와 JSON 형식 문자열 간 변환을 처리하는 라이브러리로 다음과 같이 pom.xml에 의존을 추가 &amp;lt;!-- pom.xml --&amp;gt; &amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;com.fasterxml....">

  <link href='http://cdn.jsdelivr.net/gh/joungkyun/font-d2coding/d2coding.css' rel='stylesheet' type='text/css'>
  <!-- <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'> -->

  <link rel="stylesheet" href="/assets/vendor/bootstrap/css/bootstrap.css">

  <link rel="stylesheet" href="/assets/vendor/fontawesome-free/css/all.min.css">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://owin2828.github.io/devlog/2019/12/30/spring-16.html">
  <link rel="alternate" type="application/rss+xml" title="낮코밤코" href="/feed.xml">

  <!-- 웹 폰트 설정 -->
  <!-- <link rel="stylesheet" href="http://cdn.jsdelivr.net/gh/joungkyun/font-d2coding/d2coding.css"> -->
  <link rel="stylesheet" href="/assets/syntax.css">
</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">Fake it, till U make it</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/about">About</a>
        <li class="nav-item">
          <a class="nav-link" href="/posts">All Posts</a>
        </li>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href=# id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Devlog
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <a class="dropdown-item" href="/devlog/java">Java</a>
            <a class="dropdown-item" href="/devlog/node">Node.js</a>
            <a class="dropdown-item" href="/devlog/spring">Spring</a>
          </div>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/contact">Contact</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->

<header class="masthead" style="background-image: url('/img/spring_logo.jpg')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>[Spring] 첫걸음 - 16</h1>
            
            <h2 class="subheading">JSON 응답과 요청 처리</h2>
            
            <span class="meta">Posted by
              <a href="#">owin2828</a>
              on 17:01:00 December 30, 2019 &middot; <span class="reading-time" title="Estimated read time">
  
   15 mins  read </span>

            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">

        <h2 id="1-jackson-의존-설정">1. Jackson 의존 설정</h2>
<hr />
<ul>
  <li>Jackson은 <code class="highlighter-rouge">자바 객체</code>와 <code class="highlighter-rouge">JSON</code> 형식 문자열 간 <code class="highlighter-rouge">변환</code>을 처리하는 라이브러리로 다음과 같이 pom.xml에 의존을 추가
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c">&lt;!-- pom.xml --&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>2.9.4<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
  <span class="c">&lt;!-- java8 date/time --&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.datatype<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jackson-datatype-jsr310<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>2.9.4<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>    </div>
    <p><br /></p>
  </li>
</ul>

<h2 id="2-restcontroller로-json-형식-응답">2. @RestController로 JSON 형식 응답</h2>
<hr />
<p>Spring MVC에서 <code class="highlighter-rouge">JSON</code> 형식으로 데이터를 응답하는 방법은 @Controller 대신 <code class="highlighter-rouge">@RestController</code>를 사용</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// RestMemberController.java</span>
    <span class="c1">// 기존의 @Controller 대신 새로운 어노테이션 사용</span>
    <span class="nd">@RestController</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestMemberController</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">MemberDao</span> <span class="n">memberDao</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">MemberRegisterService</span> <span class="n">registerService</span><span class="o">;</span>

        <span class="cm">/*
            * 다음 두 매서드에서 기존의 String 형태의 뷰 이름을 리턴하는 것이 아니라,
            * 일반 객체를 리턴함
            */</span>
        <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/api/members"</span><span class="o">)</span>
        <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">members</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">memberDao</span><span class="o">.</span><span class="na">selectAll</span><span class="o">();</span>
        <span class="o">}</span>
        
        <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/api/members2/{id}"</span><span class="o">)</span>
        <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">member2</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
            <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberDao</span><span class="o">.</span><span class="na">selectById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">member</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">response</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_NOT_FOUND</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">member</span><span class="o">;</span>
        <span class="o">}</span>
            <span class="o">...</span>
</code></pre></div></div>
<ul>
  <li><code class="highlighter-rouge">@RestController</code> 어노테이션을 붙인 경우 스프링 MVC는 요청 매핑 어노테이션을 붙인 객체가 리턴한 객체를<br />
<code class="highlighter-rouge">알맞은 형식</code>으로 변환해서 응답 데이터로 전송</li>
  <li>이때 클래스 패스에 <code class="highlighter-rouge">Jackson</code>이 존재하면 <code class="highlighter-rouge">JSON</code> 형식의 문자열로 변환해서 응답
    <blockquote>
      <p>스프링 4버전 이전에는 @RestController 어노테이션이 없기 때문에 다음과 같이 <code class="highlighter-rouge">@Controller</code>, <code class="highlighter-rouge">@ResponseBody</code>를 함께 사용</p>
      <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestMemberController</span> <span class="o">{</span>
     <span class="kd">private</span> <span class="nc">MemberDao</span> <span class="n">memberDao</span><span class="o">;</span>
     <span class="kd">private</span> <span class="nc">MemberRegisterService</span> <span class="n">registerService</span><span class="o">;</span>
     
     <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">path</span><span class="o">=</span><span class="s">"/api/members"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
     <span class="nd">@ResponseBody</span>
     <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="n">member</span><span class="o">&gt;</span> <span class="nf">members</span><span class="o">(){</span>
           <span class="k">return</span> <span class="n">memberDao</span><span class="o">.</span><span class="na">selectAll</span><span class="o">();</span>
     <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>      </div>
      <p><br /></p>
    </blockquote>
  </li>
</ul>

<h4 id="2-1-jsonignore를-이용한-예외-처리">2-1. @JsonIgnore를 이용한 예외 처리</h4>
<ul>
  <li>현재 구현된 응답 결과 <code class="highlighter-rouge">JSON</code>에는 비밀번호 같은 민감한 정보가 표기되므로 이를 <code class="highlighter-rouge">제외</code>해야 함</li>
  <li>다음과 같이 <code class="highlighter-rouge">@JasonIgnore</code> 어노테이션을 이용하여 이를 처리
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="o">{</span>

      <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
      <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>
      <span class="nd">@JsonIgnore</span>
      <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
      <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
      <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">registerDateTime</span><span class="o">;</span>
          <span class="o">...</span>
</code></pre></div>    </div>
    <p><br /></p>
  </li>
</ul>

<h4 id="2-2-날짜-형식-변환-처리-jsonformat">2-2. 날짜 형식 변환 처리: @JsonFormat</h4>
<ul>
  <li>앞선 코드를 보면 registerDateTime의 타입이 LocalDateTime으로써, 이는 다음과 같은 <code class="highlighter-rouge">유닉스 타임 스태프</code>로 날짜를 표기
    <ul>
      <li>“registerDateTime”: 1519870069000</li>
    </ul>
  </li>
  <li>숫자나 배열보다는 특정 형식으로 날짜를 표현하므로, 다음과 같이 <code class="highlighter-rouge">@JasonFormat</code> 어노테이션을 이용
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="o">{</span>
    
      <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
      <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>
      <span class="nd">@JsonIgnore</span>
      <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
      <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
      <span class="nd">@JsonFormat</span><span class="o">(</span><span class="n">shape</span> <span class="o">=</span> <span class="nc">Shape</span><span class="o">.</span><span class="na">STRING</span><span class="o">)</span>  <span class="c1">// ISO-8601 형식으로 변환</span>
      <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">registerDateTime</span><span class="o">;</span>
          <span class="o">...</span>
</code></pre></div>    </div>
    <ul>
      <li>“registerDateTime”: “2019-09-30T11:07:49”</li>
    </ul>
  </li>
  <li>ISO-8601 형식이 아닌 <code class="highlighter-rouge">원하는 형식</code>일 경우 다음과 같이 @JsonFormat의 <code class="highlighter-rouge">pattern</code> 속성을 이용
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@JsonFormat</span><span class="o">(</span><span class="n">pattern</span> <span class="o">=</span> <span class="s">"yyyyMMddHHmmss"</span><span class="o">)</span>  
  <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">registerDateTime</span><span class="o">;</span>
</code></pre></div>    </div>
    <ul>
      <li>“registerDateTime”: “20190930111323”
<br /></li>
    </ul>
  </li>
</ul>

<h4 id="2-3-날짜-형식-변환처리-기본-적용-설정">2-3. 날짜 형식 변환처리: 기본 적용 설정</h4>
<ul>
  <li>날짜를 지정하는 모든 형식의 앞선 어노테이션을 일일히 붙이는 것은 <code class="highlighter-rouge">비효율적</code></li>
  <li>
    <p>Spring MVC의 설정을 변경함으로 해결 가능</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// MvcConfig.java</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MvcConfig</span> <span class="kd">implements</span> <span class="nc">WebMvcConfigurer</span> <span class="o">{</span>
      <span class="o">...</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">extendMessageConverters</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">HttpMessageConverter</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">converters</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="nc">Jackson2ObjectMapperBuilder</span> <span class="c1">// 스프링이 제공하는 클래스</span>
                  <span class="o">.</span><span class="na">json</span><span class="o">()</span>
                                  <span class="c1">// 다음 매서드는 유닉스 타임스태프로 출력하는 기능을 비활성화(ISO-8601 사용)</span>
                  <span class="o">.</span><span class="na">featuresToDisable</span><span class="o">(</span><span class="nc">SerializationFeature</span><span class="o">.</span><span class="na">WRITE_DATES_AS_TIMESTAMPS</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
                 <span class="cm">/*
                  * 미리 등록된 HttpMessageConverter에는 Jackson을 사용하는 것도 포함되어 있으므로,  
                  * 새로 생성한 HttpMessageConverter는 다음과 같이 인덱스 0에 위치(맨 앞)함
                  */</span>
          <span class="n">converters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MappingJackson2HttpMessageConverter</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">));</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li><code class="highlighter-rouge">extendMessageConverters()</code> 매서드는 WebMvcConfigurer에 정의된 인터페이스로,<br />
<code class="highlighter-rouge">HttpMessageConverter</code>를 추가로 설정할 때 사용</li>
  <li>새로 생성한 <code class="highlighter-rouge">ObjectMapper</code>를 사용하는 객체를 <code class="highlighter-rouge">converters</code>의 <code class="highlighter-rouge">첫 번째</code> 항목으로 등록하면 설정 완료<br />
<br /></li>
</ul>

<h2 id="4-requestbody로-json-요청-처리">4. @RequestBody로 JSON 요청 처리</h2>
<hr />
<p>JSON 형식의 요청 데이터를 다음과 같이 커맨드 객체에 <code class="highlighter-rouge">@RequestBody</code> 어노테이션을 붙여 자바 객체로 변환</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// RestMemberController.java</span>
    <span class="nd">@RestController</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestMemberController</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/api/members"</span><span class="o">)</span>
        <span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">newMember</span><span class="o">(</span>
                            <span class="c1">// 다음 어노테이션을 붙임으로, JSON 형식의 문자열을 해당 자바 객체로 변환</span>
                <span class="nd">@RequestBody</span> <span class="nd">@Valid</span> <span class="nc">RegisterRequest</span> <span class="n">regReq</span> <span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Long</span> <span class="n">newMemberId</span> <span class="o">=</span> <span class="n">registerService</span><span class="o">.</span><span class="na">regist</span><span class="o">(</span><span class="n">regReq</span><span class="o">);</span>
                <span class="no">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"/api/members/"</span> <span class="o">+</span> <span class="n">newMemberId</span><span class="o">);</span>
                <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">created</span><span class="o">(</span><span class="n">uri</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">DuplicateMemberException</span> <span class="n">dupEx</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">CONFLICT</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="o">...</span>
    <span class="o">}</span>
</code></pre></div></div>
<p><br /></p>

<h4 id="4-1-json-데이터의-날짜-형식-다루기">4-1. JSON 데이터의 날짜 형식 다루기</h4>
<ul>
  <li>별도의 설정을 하지 않으면, JSON에서는 다음 패턴의 문자열을 LocalDateTime과 Date로 변환
    <ul>
      <li><code class="highlighter-rouge">yyyy-MM-ddTHH:mm:ss</code></li>
    </ul>
  </li>
  <li>특정 패턴은 <code class="highlighter-rouge">@JsonFormat</code> 어노테이션의 <code class="highlighter-rouge">pattern</code> 속성을 사용해 지정 가능
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@JsonFormat</span><span class="o">(</span><span class="n">pattern</span> <span class="o">=</span> <span class="s">"yyyyMMddHHmmss"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">birthDateTime</span><span class="o">;</span>
</code></pre></div>    </div>
  </li>
  <li>해당 타입을 갖는 <code class="highlighter-rouge">모든</code> 속성에 적용하려면 다음과 같이 스프링 MVC 설정을 변경
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// MvcConfig.java</span>
  <span class="nd">@Configuration</span>
  <span class="nd">@EnableWebMvc</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MvcConfig</span> <span class="kd">implements</span> <span class="nc">WebMvcConfigurer</span> <span class="o">{</span>
      <span class="o">...</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">extendMessageConverters</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">HttpMessageConverter</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">converters</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">DateTimeFormatter</span> <span class="n">formatter</span> <span class="o">=</span> <span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="na">ofPattern</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">);</span>
          <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="nc">Jackson2ObjectMapperBuilder</span>
                  <span class="o">.</span><span class="na">json</span><span class="o">()</span>
                  <span class="o">.</span><span class="na">featuresToEnable</span><span class="o">(</span><span class="nc">SerializationFeature</span><span class="o">.</span><span class="na">INDENT_OUTPUTS</span><span class="o">)</span>
                              <span class="c1">// 다음 두 줄에 걸쳐 스프링 MVC 속성을 설정  </span>
                  <span class="o">.</span><span class="na">deserializerByType</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LocalDateTimeDeserializer</span><span class="o">(</span><span class="n">formatter</span><span class="o">))</span>
                  <span class="o">.</span><span class="na">simpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
          <span class="n">converters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MappingJackson2HttpMessageConverter</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">));</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div>    </div>
    <p><br /></p>
  </li>
</ul>

<h2 id="5-responseentity로-객체-리턴하고-응답-코드-지정하기">5. ResponseEntity로 객체 리턴하고 응답 코드 지정하기</h2>
<hr />
<p>지금까지는 상태 코드를 지정하기 위해 다음과 같이 <code class="highlighter-rouge">HttpSevletResponse</code>의 <code class="highlighter-rouge">setStatus()</code>, <code class="highlighter-rouge">sendError()</code> 매서드를 이용</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/api/members2/{id}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">member2</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberDao</span><span class="o">.</span><span class="na">selectById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">member</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">response</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_NOT_FOUND</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">member</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>하지만 위와 같이 404 응답을 하면 JSON 형식이 아닌 서버가 기존으로 제공하는 <code class="highlighter-rouge">HTML</code>을 응답 결과로 제공<br />
<br /></p>

<h4 id="5-1-responseentity를-이용한-응답-데이터-처리">5-1. ResponseEntity를 이용한 응답 데이터 처리</h4>
<ul>
  <li>앞선 문제점은 <code class="highlighter-rouge">ReponseEntity</code>를 이용하여 정상/비정상인 두 경우 <code class="highlighter-rouge">모두</code> 처리 가능</li>
  <li>에러 상황일 때 응답으로 사용할 ErrorResponse 클래스를 다음과 같이 생성
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// ErrorReponse.java</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ErrorResponse</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>

      <span class="kd">public</span> <span class="nf">ErrorResponse</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getMessage</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">message</span><span class="o">;</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>앞선 클래스를 이용하여 다음과 같이 매서드를 새롭게 구성
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// RestMemberController.java</span>
  <span class="nd">@RestController</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestMemberController</span> <span class="o">{</span>
      <span class="o">...</span>
      <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/api/members/{id}"</span><span class="o">)</span>
      <span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">member</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberDao</span><span class="o">.</span><span class="na">selectById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">member</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">return</span> <span class="nc">ResponseEntity</span>
                      <span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">)</span>
                      <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="k">new</span> <span class="nc">ErrorResponse</span><span class="o">(</span><span class="s">"no member"</span><span class="o">));</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
      <span class="o">}</span>
  	    <span class="o">...</span>
  <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>스프링 MVC에서는 ReponseEntity()의 <code class="highlighter-rouge">body</code>로 지정한 객체를 이용해 변환을 처리</li>
  <li>ResponseEntity의 <code class="highlighter-rouge">status</code>로 지정한 값을 응답 상태 코드로 사용
    <blockquote>
      <p>ResponseEntity.status(상태코드).body(객체)<br />
결국, 위의 코드에서 member를 찾지 못한 에러가 발생시 다음과 같은 <code class="highlighter-rouge">JSON</code>형식의 데이터를 생성</p>
      <blockquote>
        <p><code class="highlighter-rouge">실행화면</code><br />
{<br />
      “member” : “no member”<br />
}<br />
<br /></p>
      </blockquote>
    </blockquote>
  </li>
</ul>

<h4 id="5-2-exceptionhandler-적용-매서드에서-reponseentity로-응답하기">5-2. @ExceptionHandler 적용 매서드에서 ReponseEntity로 응답하기</h4>
<ul>
  <li>앞선 코드처럼 member가 없는 에러가 여러 곳에서 발생 한다면 <code class="highlighter-rouge">코드 중복</code>이 발생</li>
  <li>이를 <code class="highlighter-rouge">@ExceptionHandler</code> 어노테이션을 적용한 매서드에서 에러처리를 하도록 구현해 해결
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// RestMemberController.java</span>
  <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/api/members3/{id}"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">member3</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberDao</span><span class="o">.</span><span class="na">selectById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">member</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">MemberNotFoundException</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">member</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// 위 매서드에서 발생하는 에러는 다음 매서드가 JSON 형식으로 처리</span>
  <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="nc">MemberNotFoundException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">ErrorResponse</span><span class="o">&gt;</span> <span class="nf">handleNoData</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">ResponseEntity</span>
              <span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">)</span>
              <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="k">new</span> <span class="nc">ErrorResponse</span><span class="o">(</span><span class="s">"no member"</span><span class="o">));</span>
  <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li><code class="highlighter-rouge">@RestControllerAdvice</code> 어노테이션을 이용해 다음처럼 에러 처리 코드를 별도 클래스로 <code class="highlighter-rouge">분리</code> 가능
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// ApiExceptionAdvice.java</span>
  <span class="nd">@RestControllerAdvice</span><span class="o">(</span><span class="s">"controller"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiExceptionAdvice</span> <span class="o">{</span>

      <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="nc">MemberNotFoundException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
      <span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">ErrorResponse</span><span class="o">&gt;</span> <span class="nf">handleNoData</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">return</span> <span class="nc">ResponseEntity</span>
                  <span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="k">new</span> <span class="nc">ErrorResponse</span><span class="o">(</span><span class="s">"no member"</span><span class="o">));</span>
      <span class="o">}</span>
      <span class="o">...</span>
  <span class="o">}</span>
</code></pre></div>    </div>
    <p><br /></p>
  </li>
</ul>

<h4 id="5-3-valid-에러-결과를-json으로-응답하기">5-3. @Valid 에러 결과를 JSON으로 응답하기</h4>
<ul>
  <li><code class="highlighter-rouge">@Valid</code> 어노테이션을 붙인 커맨드 객체가 값 검증에 실패하면 400코드를 <code class="highlighter-rouge">HTML</code> 응답으로 전송</li>
  <li>이를 해결하기 위해 다음과 같이 <code class="highlighter-rouge">Errors</code> 타입 파라미터를 추가해, <code class="highlighter-rouge">직접</code> 에러 응답을 생성
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/api/members"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">newMember</span><span class="o">(</span>
          <span class="nd">@RequestBody</span> <span class="nd">@Valid</span> <span class="nc">RegisterRequest</span> <span class="n">regReq</span><span class="o">,</span>
          <span class="nc">Errors</span> <span class="n">errors</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// hasErrors()를 호출하여 검증 에러 존재를 판별</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">errors</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
          <span class="nc">String</span> <span class="n">errorCodes</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="na">getAllErrors</span><span class="o">()</span>
                  <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                  <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">error</span> <span class="o">-&gt;</span> <span class="n">error</span><span class="o">.</span><span class="na">getCodes</span><span class="o">()[</span><span class="mi">0</span><span class="o">])</span>
                  <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">","</span><span class="o">));</span>
          <span class="k">return</span> <span class="nc">ResponseEntity</span>
                  <span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">BAD_REQUEST</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="k">new</span> <span class="nc">ErrorResponse</span><span class="o">(</span><span class="s">"errorCodes = "</span> <span class="o">+</span> <span class="n">errorCodes</span><span class="o">));</span>
      <span class="o">}</span>
      <span class="o">...</span>
</code></pre></div>    </div>
  </li>
  <li>앞선 코드에서 Errors 타입의 파라미터가 존재하지 않으면, <code class="highlighter-rouge">MethodArgumentNotValidException</code>이 발생하므로<br />
다음과 같이 <code class="highlighter-rouge">@ExceptionHandler</code> 어노테이션을 이용해 <code class="highlighter-rouge">분리</code>가능
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// ApiExceptionAdvice.java</span>
  <span class="nd">@RestControllerAdvice</span><span class="o">(</span><span class="s">"controller"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiExceptionAdvice</span> <span class="o">{</span>
      <span class="o">...</span>
      <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="nc">MethodArgumentNotValidException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
      <span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">ErrorResponse</span><span class="o">&gt;</span> <span class="nf">handleBindException</span><span class="o">(</span><span class="nc">MethodArgumentNotValidException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">String</span> <span class="n">errorCodes</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">getBindingResult</span><span class="o">().</span><span class="na">getAllErrors</span><span class="o">()</span>
                  <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                  <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">error</span> <span class="o">-&gt;</span> <span class="n">error</span><span class="o">.</span><span class="na">getCodes</span><span class="o">()[</span><span class="mi">0</span><span class="o">])</span>
                  <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">","</span><span class="o">));</span>
          <span class="k">return</span> <span class="nc">ResponseEntity</span>
                  <span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">BAD_REQUEST</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="k">new</span> <span class="nc">ErrorResponse</span><span class="o">(</span><span class="s">"errorCodes = "</span> <span class="o">+</span> <span class="n">errorCodes</span><span class="o">));</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>


        <hr>

        <div class="clearfix">

          
          <a class="btn btn-primary float-left" href="/devlog/2019/12/30/spring-15.html" data-toggle="tooltip" data-placement="top" title="[Spring] 첫걸음 - 15">&larr; Previous<span class="d-none d-md-inline">
              Post</span></a>
          
          
          <a class="btn btn-primary float-right" href="/devlog/2019/12/30/spring-17.html" data-toggle="tooltip" data-placement="top" title="[Spring] 첫걸음 - 17">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          

        </div>

      </div>
    </div>
  </div>




  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <ul class="list-inline text-center">
          
          <li class="list-inline-item">
            <a href="mailto:owin2828@gmail.com">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
          
          
          <li class="list-inline-item">
            <a href="https://github.com/owin2828">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="copyright text-muted">Copyright &copy; owin2828 2019</p>
      </div>
    </div>
  </div>
</footer>


  <script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/clean-blog.min.js"></script>

<script src="/assets/scripts.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154694140-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154694140-1');
</script>



</body>

</html>
